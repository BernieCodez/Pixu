<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pixalu</title>
    <link rel="stylesheet" href="styles/base.css" />
    <link rel="stylesheet" href="styles/canvas-components.css" />
    <link rel="stylesheet" href="styles/ui-components.css" />

    <!-- base.css - Core styling, reset, layout, buttons, and basic UI elements -->
    <!-- canvas-components.css - Canvas-specific components, sidebars, toolbars, and drawing area -->
    <!-- ui-components.css - Properties panel, modals, forms, and interactive UI components -->

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsgif@1.0.1/GIFEncoder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="js/settingsMenu.js"></script>
  </head>

  <body>
    <div class="app-container">
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <h1 class="app-title">
            <i class="fas fa-palette"></i>
            Pixalu
          </h1>
        </div>
        <div class="toolbar-group">
          <button class="tool-btn" id="zoom-in" data-tooltip="Zoom In">
            <i class="fas fa-search-plus"></i>
          </button>
          <button class="tool-btn" id="zoom-out" data-tooltip="Zoom Out">
            <i class="fas fa-search-minus"></i>
          </button>
          <button class="tool-btn" id="toggle-grid" data-tooltip="Toggle Grid">
            <i class="fas fa-th"></i>
          </button>
        </div>
        <div class="header-center">
          <div class="canvas-size-inputs">
            <label for="canvas-width-header">W:</label>
            <input
              type="number"
              id="canvas-width-header"
              min="1"
              max="128"
              value="16"
              class="size-input"
            />
            <label for="canvas-height-header">H:</label>
            <input
              type="number"
              id="canvas-height-header"
              min="1"
              max="128"
              value="16"
              class="size-input"
            />
          </div>
          <span id="sprite-name-display" class="sprite-name-display"
            >Untitled</span
          >
          <button
            class="btn btn-sm"
            id="edit-sprite-name"
            data-tooltip="Edit Sprite Name"
            class="edit-name-btn"
          >
            <i class="fas fa-edit"></i>
          </button>
        </div>
        <div class="toolbar-group">
          <button class="tool-btn" id="undo-btn" data-tooltip="Undo">
            <i class="fas fa-undo"></i>
          </button>
          <button class="tool-btn" id="redo-btn" data-tooltip="Redo">
            <i class="fas fa-redo"></i>
          </button>
        </div>
        <div class="header-right">
          <button class="btn btn-primary" id="new-sprite" data-tooltip="New Sprite">
            <i class="fas fa-plus"></i>
            New
          </button>
          <button class="btn btn-secondary" id="import-btn" data-tooltip="Import Sprite">
            <i class="fas fa-file-import"></i>
            Import
          </button>
          <button class="btn btn-success" id="export-btn" data-tooltip="Export Sprite">
            <i class="fas fa-download"></i>
            Export
          </button>
          <div id="editor-container"></div>
          <button class="btn btn-secondary" id="settings-btn" data-tooltip="Settings">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </header>

      <!-- Export Modal -->
      <div class="modal" id="export-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Export Sprite</h3>
            <button class="modal-close" id="export-modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="input-group">
              <label for="export-format">Format:</label>
              <select id="export-format" class="export-format-select">
                <option value="svg">SVG (Vector)</option>
                <option value="png">PNG (Raster)</option>
                <option value="gif">GIF (Animated)</option>
              </select>
            </div>

            <div class="input-group" id="scale-group">
              <label for="export-scale"
                >Scale: <span id="scale-value">1x</span></label
              >
              <div class="slider-container">
                <input
                  type="range"
                  id="export-scale"
                  min="1"
                  max="32"
                  value="1"
                  class="export-slider"
                />
              </div>
            </div>

            <div class="input-group" id="fps-group" style="display: none">
              <label for="export-fps"
                >Frame Rate (FPS): <span id="fps-value">12</span></label
              >
              <div class="slider-container">
                <input
                  type="range"
                  id="export-fps"
                  min="1"
                  max="60"
                  value="12"
                  class="export-slider"
                />
              </div>
            </div>

            <div class="export-preview">
              <div id="export-dimensions">16x16 â†’ 16x16</div>
              <div id="export-animation-info" style="display: none">
                Animation: <span id="frame-count">1</span> frames
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-export">Cancel</button>
            <button class="btn btn-primary" id="quick-export">
              Quick Export (20x)
            </button>
            <button
              class="btn btn-warning"
              id="export-spritesheet"
              style="display: none"
            >
              <i class="fas fa-th"></i> Export Spritesheet
            </button>
            <button class="btn btn-success" id="apply-export">Export</button>
          </div>
        </div>
      </div>

      <!-- Settings Menu Modal -->
      <div id="settings-menu" class="settings-menu">
        <div class="settings-menu-content">
          <button id="settings-close" class="settings-close" data-tooltip="Close">
            <i class="fas fa-times"></i>
          </button>
          <h2>Settings</h2>
          <!-- Add your settings content here -->
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-container">
        <!-- Sprite Sidebar (moved to far left) -->
        <aside class="sidebar" id="sprites-sidebar">
          <div class="sidebar-section">
            <h3>Recent Sprites</h3>
            <button class="btn btn-secondary btn-sm" id="pick-folder" data-tooltip="Pick Sprites">
              <i class="fas fa-folder-open"></i>
              Pick Sprites Folder
            </button>
            <div class="recent-sprites" id="recent-sprites">
              <div class="no-sprites-message">
                <i class="fas fa-image"></i>
                <p>No sprites folder selected</p>
                <p class="help-text">Pick a folder to save and load sprites</p>
              </div>
            </div>
          </div>
          <div class="sidebar-section">
            <h3>Current Session</h3>
            <div class="sprites-list" id="sprites-list">
              <!-- Sprite thumbnails will be populated here -->
            </div>
          </div>
        </aside>

        <!-- Toolbox Sidebar (moved closer to canvas) -->
        <aside class="toolbox-sidebar">
          <div class="toolbox-section">
            <h3>Tools</h3>
            <div class="toolbox-tools">
              <button class="tool-btn" data-tool="brush" data-tooltip="Brush Tool">
                <i class="fas fa-paintbrush"></i>
              </button>
              <button class="tool-btn" data-tool="eraser" data-tooltip="Eraser Tool">
                <i class="fas fa-eraser"></i>
              </button>
              <button class="tool-btn" data-tool="shape" data-tooltip="Shape Tool">
                <i class="fa-regular fa-circle"></i>
              </button>
              <button class="tool-btn" data-tool="bucket" data-tooltip="Bucket Fill">
                <i class="fas fa-fill-drip"></i>
              </button>
              <button class="tool-btn" data-tool="select" data-tooltip="Select Tool">
                <i class="fas fa-vector-square"></i>
              </button>
              <button
                class="tool-btn"
                data-tool="eyedropper"
                data-tooltip="Eyedropper"
              >
                <i class="fas fa-eye-dropper"></i>
              </button>
              <button
                class="tool-btn"
                data-tool="brightness"
                data-tooltip="Brightness Tool"
              >
                <i class="fas fa-sun"></i>
              </button>
              <button
                class="tool-btn"
                data-tool="smoothsharpen"
                data-tooltip="Smooth/Sharpen Tool"
              >
                <i class="fas fa-brush"></i>
              </button>

              <button
                class="tool-btn"
                data-tool="miscellaneous"
                data-tooltip="Miscellaneous Tool"
              >
                <i class="fas fa-wrench"></i>
              </button>
            </div>
          </div>
        </aside>

        <!-- Canvas Area -->
        <main class="canvas-area">
          <div class="canvas-toolbar">
            <div class="canvas-scroll">
              <div class="toolbar-group">
                <!-- Tool Settings (moved from properties panel) -->
                <div class="tool-settings" id="tool-settings">
                  <div class="setting-group brush-settings">
                    <label for="brush-size">Brush Size:</label>
                    <div class="slider-container">
                      <input
                        type="range"
                        id="brush-size"
                        min="1"
                        max="10"
                        value="1"
                      />
                      <span class="slider-value">1</span>
                    </div>
                  </div>
                  <div class="setting-group brush-settings">
                    <label for="brush-opacity">Opacity:</label>
                    <div class="slider-container">
                      <input
                        type="range"
                        id="brush-opacity"
                        min="0"
                        max="100"
                        value="100"
                      />
                      <span class="slider-value">100%</span>
                    </div>
                  </div>
                  <div
                    class="setting-group bucket-settings"
                    style="display: none"
                  >
                    <label for="bucket-tolerance">Tolerance:</label>
                    <div class="slider-container">
                      <input
                        type="range"
                        id="bucket-tolerance"
                        min="0"
                        max="100"
                        value="10"
                      />
                      <span class="slider-value">10</span>
                    </div>
                  </div>
                  <div
                    class="setting-group brightness-settings"
                    style="display: none"
                  >
                    <label for="brightness-intensity">Intensity:</label>
                    <div class="slider-container">
                      <input
                        type="range"
                        id="brightness-intensity"
                        min="-50"
                        max="50"
                        value="10"
                      />
                      <span class="slider-value">+10%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="canvas-container">
            <button
              class="btn generate-ai-button"
              id="generate-ai-button"
              data-tooltip="Generate AI Pixel Art"
            >
              <i class="fa fa-wand-magic-sparkles"></i>
            </button>
            <div class="canvas-data" id="canvas-data">
              <div id="current-zoom">Zoom: 20x</div>
              <div id="current-frame">Frame: 1/1</div>
              <div id="canvas-dimensions">Canvas: 16 x 16</div>
              <div id="mouse-coordinates">Cursor X & Y: (0, 0)</div>
            </div>
            <canvas id="main-canvas" width="512" height="512"></canvas>
            <canvas id="overlay-canvas" width="512" height="512"></canvas>
            <div id="konva-container"></div>
          </div>
          <!-- Frames Row -->
          <div class="frames-row" id="frames-row">
            <button
              class="frames-toggle-btn"
              id="frames-toggle-btn"
              data-tooltip="Toggle Frames Panel"
            >
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="frames-content" id="frames-content">
              <div class="frames-toolbar">
                <button class="btn btn-sm" id="add-frame-btn">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="btn btn-sm" id="duplicate-frame-btn">
                  <i class="fas fa-copy"></i>
                </button>
                <button class="btn btn-sm" id="delete-frame-btn">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
              <div class="frames-list" id="frames-list">
                <!-- Frame thumbnails will be populated here -->
              </div>
            </div>
          </div>
        </main>

        <!-- Properties Panel -->
        <aside class="properties-panel">
          <div class="panel-section">
            <h3>Color</h3>
            <div class="color-section">
              <div class="color-picker-container">
                <input type="color" id="color-picker" value="#000000" />
                <div class="color-display">
                  <div class="primary-color" id="primary-color"></div>
                  <div class="secondary-color" id="secondary-color"></div>
                </div>
              </div>

              <div class="color-wheel-container">
                <div id="color-wheel"></div>
              </div>

              <div id="color-value-container" class="color-value-container">
                <button
                  id="toggle-color-mode"
                  class="btn btn-secondary color-mode-toggle"
                  data-tooltip="Toggle Color Mode"
                >
                  Show RGB
                </button>
                <label for="color-hex" id="label-hex">HEX:</label>
                <input
                  type="text"
                  id="color-hex"
                  maxlength="7"
                  size="7"
                  value="#000000"
                />
                <label for="color-rgb" id="label-rgb" class="rgb-label"
                  >RGB:</label
                >
                <input
                  type="text"
                  id="color-rgb"
                  maxlength="16"
                  size="16"
                  value="rgb(0,0,0)"
                  class="rgb-input"
                />
              </div>

              <div class="color-palette" id="color-palette">
                <!-- Color swatches will be populated here -->
              </div>
            </div>
            <!-- New canvas colors palette -->
            <div class="canvas-colors-section">
              <div id="canvas-colors-palette" class="canvas-colors-palette">
                <!-- Canvas colors will be dynamically inserted here -->
              </div>
            </div>
          </div>

          <div class="panel-section">
            <h3>Layers</h3>
            <!-- Update the layers-controls section to include merge button: -->
            <div class="layers-controls">
              <button
                class="btn btn-sm"
                id="add-layer-btn"
                data-tooltip="Add Layer"
                class="layer-control-btn"
              >
                <i class="fas fa-plus"></i>
              </button>
              <button
                class="btn btn-sm"
                id="duplicate-layer-btn"
                data-tooltip="Duplicate Layer"
                class="layer-control-btn"
              >
                <i class="fas fa-copy"></i>
              </button>
              <button
                class="btn btn-sm"
                id="merge-layer-btn"
                data-tooltip="Merge Layer Down"
                class="layer-control-btn"
              >
                <i class="fas fa-arrows-down-to-line"></i>
              </button>
              <button
                class="btn btn-sm"
                id="delete-layer-btn"
                data-tooltip="Delete Layer"
                class="layer-control-btn"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
            <div class="layers-list" id="layers-list">
              <!-- Layers will be populated here by JavaScript -->
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="downscale-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Image Too Large - Downscale Required</h3>
          <button class="modal-close" id="downscale-modal-close">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="downscale-info">
            <p>
              The imported image is <span id="original-dimensions"></span> which
              exceeds the maximum size of 64x64 pixels.
            </p>
            <p>Please choose a target size for downscaling:</p>
          </div>

          <div class="input-group">
            <label for="target-width">Target Width:</label>
            <input
              type="number"
              id="target-width"
              min="1"
              max="64"
              value="32"
            />
          </div>

          <div class="input-group">
            <label for="target-height">Target Height:</label>
            <input
              type="number"
              id="target-height"
              min="1"
              max="64"
              value="32"
            />
          </div>

          <div class="checkbox-group">
            <label>
              <input type="checkbox" id="maintain-aspect-downscale" checked />
              Maintain aspect ratio
            </label>
          </div>

          <div class="downscale-preview-container">
            <div class="preview-section">
              <h4>Original</h4>
              <canvas id="original-preview" width="128" height="128"></canvas>
              <div id="original-size-info"></div>
            </div>
            <div class="preview-section">
              <h4>Downscaled Preview</h4>
              <canvas id="downscaled-preview" width="128" height="128"></canvas>
              <div id="downscaled-size-info"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancel-downscale">
            Cancel
          </button>
          <button class="btn btn-primary" id="apply-downscale">
            Create Sprite
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="resize-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Resize Canvas</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <label for="canvas-width">Width:</label>
            <input
              type="number"
              id="canvas-width"
              min="1"
              max="128"
              value="16"
            />
          </div>
          <div class="input-group">
            <label for="canvas-height">Height:</label>
            <input
              type="number"
              id="canvas-height"
              min="1"
              max="128"
              value="16"
            />
          </div>
          <div class="checkbox-group">
            <label>
              <input type="checkbox" id="maintain-aspect-ratio" />
              Maintain aspect ratio
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancel-resize">Cancel</button>
          <button class="btn btn-primary" id="apply-resize">Apply</button>
        </div>
      </div>
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-modal-overlay" id="confirm-modal" style="display: none">
      <div class="confirm-modal-content">
        <div class="confirm-modal-header">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Confirm Action</h3>
        </div>

        <div class="confirm-modal-message" id="confirm-modal-message">
          <!-- Message will be inserted here -->
        </div>

        <div class="confirm-modal-actions">
          <button
            id="confirm-cancel"
            class="confirm-modal-btn confirm-modal-btn-secondary"
          >
            Cancel
          </button>
          <button
            id="confirm-confirm"
            class="confirm-modal-btn confirm-modal-btn-danger"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>

    <!-- AI Generator Modal -->
    <div class="modal" id="ai-generator-modal" style="display: none">
      <div class="modal-content ai-modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-magic"></i> AI Assistant</h3>
          <button class="modal-close" id="ai-modal-close">&times;</button>
        </div>

        <!-- Mode Switch Tabs -->
        <div class="mode-tabs">
          <button id="generate-tab" class="mode-tab generate active">
            <i class="fas fa-image"></i> Generate Pixel Art
          </button>
          <button id="chat-tab" class="mode-tab chat">
            <i class="fas fa-comments"></i> Chat Assistant
          </button>
        </div>

        <div class="modal-body">
          <!-- Generate Mode -->
          <div id="generate-mode">
            <div class="ai-info-box generate">
              <h4><i class="fas fa-info-circle"></i> AI Image Generation</h4>
              <p>
                Using Pollinations.AI for real-time image generation with
                advanced pixel art processing.
              </p>
              <p class="help-text">
                Generated images are processed with improved color quantization
                algorithms.
              </p>
            </div>

            <div class="input-group">
              <label for="ai-prompt">Prompt:</label>
              <textarea
                id="ai-prompt"
                class="ai-prompt-textarea"
                placeholder="Describe your pixel art (e.g., 'medieval castle, 16-bit style', 'retro spaceship', 'fantasy sword')"
                rows="3"
              >
pixel art medieval castle, 16-bit retro game style</textarea
              >
            </div>

            <div class="ai-settings-grid">
              <div class="input-group">
                <label for="ai-canvas-size">Target Canvas Size:</label>
                <select id="ai-canvas-size" class="ai-select">
                  <option value="16">16x16</option>
                  <option value="32" selected>32x32</option>
                  <option value="48">48x48</option>
                  <option value="64">64x64</option>
                </select>
              </div>

              <div class="input-group">
                <label for="ai-model">AI Model:</label>
                <select id="ai-model" class="ai-select">
                  <option value="flux" selected>Flux</option>
                  <option value="turbo">Turbo</option>
                  <option value="flux-realism">Flux Realism</option>
                  <option value="flux-cablyai">Flux CablyAI</option>
                  <option value="flux-anime">Flux Anime</option>
                  <option value="any-dark">Any Dark</option>
                </select>
              </div>
            </div>

            <div class="ai-settings-grid">
              <div class="input-group">
                <label for="ai-color-palette">Color Palette:</label>
                <select id="ai-color-palette" class="ai-select">
                  <option value="full" selected>Full Color</option>
                  <option value="retro">Retro 16-Color</option>
                  <option value="gameboy">Game Boy Green</option>
                  <option value="nes">NES Palette</option>
                  <option value="c64">Commodore 64</option>
                  <option value="pico8">PICO-8</option>
                </select>
              </div>
            </div>

            <div class="ai-status" id="ai-status"></div>

            <div
              class="ai-preview-container"
              id="ai-preview-container"
              style="display: none"
            >
              <div class="ai-preview-grid">
                <div class="ai-preview-section">
                  <h4>AI Generated</h4>
                  <canvas
                    id="ai-original-canvas"
                    class="ai-preview-canvas"
                  ></canvas>
                </div>
                <div class="ai-preview-section">
                  <h4>Pixel Art Result</h4>
                  <canvas
                    id="ai-pixel-canvas"
                    class="ai-preview-canvas pixelated"
                  ></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Chat Mode -->
          <div id="chat-mode" style="display: none">
            <div class="ai-info-box chat">
              <h4><i class="fas fa-info-circle"></i> AI Chat Assistant</h4>
              <p>
                Get help with pixel art techniques, color theory, design ideas,
                and creative inspiration.
              </p>
              <p class="help-text">
                Ask about palettes, art styles, or any creative questions!
              </p>
            </div>

            <div class="chat-container">
              <div id="chat-messages" class="chat-messages">
                <div class="chat-message assistant">
                  <div class="chat-message-sender">AI Assistant</div>
                  <div class="chat-message-content">
                    Hello! I'm here to help with your pixel art projects. Ask me
                    about color palettes, art techniques, creative themes, or
                    any design questions you have!
                  </div>
                </div>
              </div>

              <div class="chat-input-container">
                <input
                  type="text"
                  id="chat-input"
                  class="chat-input"
                  placeholder="Ask me about pixel art, color theory, design ideas..."
                  onkeypress="if(event.key==='Enter') window.aiGenerator.sendChatMessage()"
                />
                <button id="chat-send" class="chat-send-btn">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <div id="generate-buttons" class="modal-footer-buttons">
            <button class="btn btn-secondary" id="ai-cancel">Cancel</button>
            <button class="btn btn-primary" id="ai-generate">
              <i class="fas fa-magic"></i> Generate
            </button>
            <button class="btn btn-success" id="ai-apply" style="display: none">
              <i class="fas fa-plus"></i> Add to Canvas
            </button>
          </div>

          <div
            id="chat-buttons"
            class="modal-footer-buttons"
            style="display: none"
          >
            <button class="btn btn-secondary" id="chat-close">Close</button>
            <button class="btn btn-warning" id="chat-clear">
              <i class="fas fa-trash"></i> Clear Chat
            </button>
          </div>
        </div>
      </div>
    </div>

    <input
      type="file"
      id="file-input"
      accept=".png,.jpg,.jpeg,.svg"
      style="display: none"
    />

    <!-- Scripts -->
    <script src="js/storage.js"></script>
    <script src="js/sprite.js"></script>
    <script src="js/canvas.js"></script>
    <script src="js/layerManager.js"></script>
    <script src="js/recentSprites.js"></script>
    <script src="js/tools/brush.js"></script>
    <script src="js/tools/eraser.js"></script>
    <script src="js/tools/bucket.js"></script>
    <script src="js/tools/select.js"></script>
    <script src="js/tools/eyedropper.js"></script>
    <script src="js/tools/brightness.js"></script>
    <script src="js/tools/smoothsharpen.js"></script>
    <script src="js/tools/shape.js"></script>
    <script src="js/tools/miscellaneous.js"></script>
    <script src="js/uiController.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/aiGenerator.js"></script>
    <script src="js/animation.js"></script>
    <script src="main.js" defer></script>
  </body>
</html>
