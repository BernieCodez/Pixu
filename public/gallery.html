<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gallery - Pixalu</title>
    <link rel="stylesheet" href="/css/main.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <a href="/" class="nav-logo"><i class="fas fa-palette"></i> Pixalu</a>
        <ul class="nav-menu">
          <li><a href="/">Home</a></li>
          <li><a href="/pricing">Pricing</a></li>
          <li><a href="/gallery" class="active">Gallery</a></li>
          <li><a href="/editor">Editor</a></li>
        </ul>
        <div class="nav-auth" id="nav-auth">
          <a href="/auth" class="btn btn-secondary">Login</a>
          <a href="/auth" class="btn btn-primary">Sign Up</a>
        </div>
      </div>
    </nav>

    <main class="gallery-page">
      <section class="gallery-hero">
        <h1>Community Gallery</h1>
        <p>Explore amazing pixel art from our community</p>
        <div class="gallery-filters">
          <button class="filter-btn active" data-sort="recent">Recent</button>
          <button class="filter-btn" data-sort="popular">Popular</button>
          <div style="position: relative; flex: 1; max-width: 400px;">
            <input
              type="text"
              class="search-input"
              placeholder="Search by tags or users..."
              id="search-input"
            />
            <div id="search-results" style="
              position: absolute;
              top: 100%;
              left: 0;
              right: 0;
              background: white;
              border: 1px solid #e2e8f0;
              border-radius: 8px;
              margin-top: 5px;
              max-height: 300px;
              overflow-y: auto;
              display: none;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
              z-index: 100;
            "></div>
          </div>
        </div>
      </section>

      <section class="gallery-grid" id="gallery-grid">
        <!-- Gallery items will be populated here -->
        <div class="gallery-loading">
          <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>
      </section>
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA5kRKtJvgBxT1_suMUNjJHRW7M-7V03Wk",
        authDomain: "pixaluapp.firebaseapp.com",
        projectId: "pixaluapp",
        storageBucket: "pixaluapp.firebasestorage.app",
        messagingSenderId: "645940179071",
        appId: "1:645940179071:web:d1d361f07a773b321b8f4a",
        measurementId: "G-41CZ9Q72Z3",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // Check for auto-login with JWT
      async function checkAutoLogin() {
        const token = localStorage.getItem('pixalu_auth_token');
        
        if (token) {
          try {
            const response = await fetch('/api/auth/verify', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ token })
            });
            
            if (response.ok) {
              const data = await response.json();
              updateNavBar(data.user);
              return data.user;
            } else {
              localStorage.removeItem('pixalu_auth_token');
              localStorage.removeItem('pixalu_session_token');
            }
          } catch (error) {
            console.error('Auto-login failed:', error);
          }
        }
        return null;
      }

      function updateNavBar(user) {
        const navAuth = document.getElementById("nav-auth");
        if (user) {
          // Always use the latest displayName from the user object
          const displayName = user.displayName || user.email.split('@')[0];
          navAuth.innerHTML = `
            <a href="/user?email=${encodeURIComponent(user.email)}" class="btn btn-secondary">
              <i class="fas fa-user"></i> My Profile
            </a>
            <span>Welcome, ${displayName}</span>
            <button class="btn btn-secondary" id="logout-btn">Logout</button>
          `;
          
          const logoutBtn = document.getElementById("logout-btn");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", async () => {
              try {
                const token = localStorage.getItem('pixalu_auth_token');
                if (token) {
                  await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                  });
                }
                localStorage.removeItem('pixalu_auth_token');
                localStorage.removeItem('pixalu_session_token');
                await signOut(auth);
                window.location.reload();
              } catch (error) {
                console.error("Logout error:", error);
                alert("Failed to logout. Please try again.");
              }
            });
          }
        }
      }

      // Try auto-login first
      checkAutoLogin();

      // Also listen to Firebase auth changes
      onAuthStateChanged(auth, async (user) => {
        if (user && !localStorage.getItem('pixalu_auth_token')) {
          // User is logged in with Firebase but no JWT, try to get fresh data
          try {
            const firebaseToken = await user.getIdToken();
            const response = await fetch('/api/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                email: user.email,
                firebaseToken: firebaseToken
              })
            });
            
            if (response.ok) {
              const data = await response.json();
              localStorage.setItem('pixalu_auth_token', data.token);
              localStorage.setItem('pixalu_session_token', data.sessionToken);
              updateNavBar(data.user);
            } else {
              // Fallback to Firebase user data
              updateNavBar({
                email: user.email,
                displayName: user.displayName || user.email.split('@')[0],
                uid: user.uid
              });
            }
          } catch (error) {
            console.error('Token generation failed:', error);
            updateNavBar({
              email: user.email,
              displayName: user.displayName || user.email.split('@')[0],
              uid: user.uid
            });
          }
        }
      });

      let currentSort = "recent";
      let searchTimeout = null;

      // Search functionality
      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
          searchResults.style.display = 'none';
          return;
        }
        
        searchTimeout = setTimeout(() => searchUsers(query), 300);
      });
      
      // Close search results when clicking outside
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
          searchResults.style.display = 'none';
        }
      });
      
      async function searchUsers(query) {
        try {
          const response = await fetch(`/api/auth/search?q=${encodeURIComponent(query)}`);
          const data = await response.json();
          
          if (data.users && data.users.length > 0) {
            searchResults.innerHTML = data.users.map(user => `
              <a href="/user?email=${encodeURIComponent(user.email)}" style="
                display: block;
                padding: 12px 16px;
                color: #2d3748;
                text-decoration: none;
                border-bottom: 1px solid #f7fafc;
                transition: background 0.2s;
              " onmouseover="this.style.background='#f7fafc'" onmouseout="this.style.background='white'">
                <div style="font-weight: 600;">${user.displayName || user.email}</div>
                <div style="font-size: 12px; color: #718096;">${user.email}</div>
              </a>
            `).join('');
            searchResults.style.display = 'block';
          } else {
            searchResults.innerHTML = `
              <div style="padding: 20px; text-align: center; color: #718096;">
                No users found
              </div>
            `;
            searchResults.style.display = 'block';
          }
        } catch (error) {
          console.error('Search error:', error);
        }
      }

      async function loadGallery(sort = "recent") {
        const grid = document.getElementById("gallery-grid");
        grid.innerHTML =
          '<div class="gallery-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

        try {
          const response = await fetch(`/api/gallery?sort=${sort}&limit=20`);
          const data = await response.json();

          // Handle error in response
          if (data.error) {
            console.error("Gallery API error:", data.error);
          }

          // Check if items exist and has length
          if (!data.items || data.items.length === 0) {
            grid.innerHTML = `
                <div class="no-items">
                    <i class="fas fa-image" style="font-size: 48px; margin-bottom: 15px; color: #444;"></i>
                    <p>No pixel art in the gallery yet.</p>
                    <p style="font-size: 14px; color: #666;">Be the first to share your creation!</p>
                </div>
            `;
            return;
          }

          grid.innerHTML = data.items
            .map(
              (item) => `
            <div class="gallery-item">
                <img src="${item.imageUrl}" alt="${
                item.title
              }" class="gallery-image">
                <div class="gallery-info">
                    <h3>${item.title}</h3>
                    <p>${item.description || "No description"}</p>
                    <div class="gallery-stats">
                        <span><i class="fas fa-heart"></i> ${
                          item.likes || 0
                        }</span>
                        <span><i class="fas fa-eye"></i> ${
                          item.views || 0
                        }</span>
                    </div>
                    ${item.userEmail ? `
                      <div style="margin-top: 8px;">
                        <a href="/user?email=${encodeURIComponent(item.userEmail)}" 
                           style="color: #667eea; font-size: 12px; text-decoration: none;">
                          <i class="fas fa-user"></i> View Artist
                        </a>
                      </div>
                    ` : ''}
                </div>
            </div>
        `
            )
            .join("");
        } catch (error) {
          console.error("Failed to load gallery:", error);
          grid.innerHTML = `
            <div class="error">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px; color: #ff6b6b;"></i>
                <p>Failed to load gallery.</p>
                <p style="font-size: 14px;">Please try again later.</p>
            </div>
        `;
        }
      }

      // Filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentSort = btn.dataset.sort;
          loadGallery(currentSort);
        });
      });

      loadGallery();
    </script>
  </body>
</html>
